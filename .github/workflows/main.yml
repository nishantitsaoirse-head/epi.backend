name: Deploy Backend to AWS EC2
run-name: "ğŸš€ Deployment triggered by ${{ github.actor }} on branch ${{ github.ref_name }}"

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  deploy:
    name: Backend Deployment
    runs-on: ubuntu-24.04

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      NODE_ENV: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies (auto-fallback)
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci || npm install

      - name: Syntax validation
        run: |
          echo "ğŸ” Checking Node.js syntax..."
          node --check index.js

      - name: ğŸš€ Deploy application to EC2
        run: |
          # Save private key
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem

          echo "Connecting to EC2 and deploying..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
          set -e
          echo "ğŸš€ Deployment started on EC2..."
          
          sudo mkdir -p /var/www/epi-backend
          sudo chown ubuntu:ubuntu /var/www/epi-backend
          cd /var/www/epi-backend
          
          echo "ğŸ§¹ Cleaning up temporary files..."
          sudo rm -rf /tmp/* || true
          sudo journalctl --vacuum-time=3d || true
          echo "âœ… Cleanup completed"
          
          echo "ğŸ” Setting up SSH config for GitHub..."
          mkdir -p ~/.ssh
          cat <<CONFIG_EOF > ~/.ssh/config
          Host github.com
              HostName github.com
              User git
              IdentityFile ~/.ssh/epi-backend
              IdentitiesOnly yes
          CONFIG_EOF
          
          chmod 600 ~/.ssh/config
          
          # Pull latest repo version
          if [ -d .git ]; then
            echo "ğŸ”„ Repo found â€” pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main
          else
            echo "ğŸ†• Cloning repository..."
            git clone git@github.com:nabeelanasaritsaoirse/epi-backend.git .
          fi
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --omit=dev
          
          echo "ğŸ§¾ Writing environment variables..."
          cat <<ENVEND > .env
          PORT=5000
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
          ENVEND
          
          echo "ğŸ” Restarting PM2..."
          if pm2 describe epi-backend > /dev/null; then
              pm2 restart epi-backend
          else
              pm2 start index.js --name epi-backend
          fi
          
          pm2 save
          
          echo "-------------------------------------"
          echo "âœ… Deployment completed successfully!"
          PUBLIC_IP=$(curl -s http://checkip.amazonaws.com)
          echo "ğŸŒ Your API is live at: http://$PUBLIC_IP:5000"
          echo "-------------------------------------"
          EOF
