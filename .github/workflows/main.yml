name: Deploy Node.js Backend to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: runs-on: ubuntu-24.04

    env:
      NODE_ENV: production
      AWS_REGION: ap-south-1
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

    steps:
      # üõ†Ô∏è Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # üü¢ Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # üì¶ Step 3: Install dependencies (clean)
      - name: Install dependencies
        run: npm ci

      # üßπ Step 4: Basic lint check
      - name: Run lint check
        run: |
          echo "Running lint check..."
          npx eslint . || echo "‚ö†Ô∏è Lint warnings detected, continuing deployment"

      # üß™ Step 5: Syntax and startup validation
      - name: Run basic syntax test
        run: |
          echo "Performing syntax validation..."
          node --check index.js
          echo "‚úÖ Node.js syntax validation passed"

      # üöÄ Step 6: Deploy to AWS EC2
      - name: Deploy backend to EC2
        run: |
          echo "Deploying to EC2 instance..."
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e
            echo "üì¶ Pulling latest code..."
            cd /var/www/epi-backend || exit 1
            git fetch origin main
            git reset --hard origin/main

            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev

            echo "üîÑ Restarting backend service with PM2..."
            pm2 restart epi-backend || pm2 start npm --name "epi-backend" -- start
            pm2 save

            echo "‚úÖ Deployment completed successfully!"
          EOF

      # üßæ Step 7: Add summary to GitHub Actions
      - name: Add Deployment Summary
        if: success()
        run: |
          echo "## ‚úÖ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** Epi Backend" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** AWS EC2 (${AWS_REGION})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Host:** http://${{ env.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployed successfully via GitHub Actions" >> $GITHUB_STEP_SUMMARY

      # üí¨ Step 8: Notify Microsoft Teams on success
      - name: Notify Teams (Success)
        if: success()
        uses: toko-bifrost/ms-teams-deploy-card@v1
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ env.TEAMS_WEBHOOK_URL }}
          show-on-start: false

      # ‚ùå Step 9: Notify Microsoft Teams on failure
      - name: Notify Teams (Failure)
        if: failure()
        uses: toko-bifrost/ms-teams-deploy-card@v1
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ env.TEAMS_WEBHOOK_URL }}
          show-on-failure: true
