name: üöÄ Deploy Backend to AWS EC2

on:
  push:
    branches:
      - main  # Deploy automatically when code is pushed to main branch

permissions:
  contents: read

jobs:
  deploy:
    name: Backend Deployment
    runs-on: ubuntu-24.04

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
      NODE_ENV: production

    steps:
      # üõ†Ô∏è Step 1: Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # üü¢ Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # üì¶ Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # üßπ Step 4: Syntax validation
      - name: Syntax validation
        run: |
          echo "üîç Checking Node.js syntax..."
          node --check index.js

     # üöÄ Step 5: Deploy to EC2 via SSH
      - name: Deploy application to EC2
        run: |
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
      
          echo "üîê Connecting to EC2 and deploying..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e
            echo "üöÄ Deployment started on EC2..."
      
            # Ensure the repo directory exists
            sudo mkdir -p /var/www/epi-backend
            sudo chown ubuntu:ubuntu /var/www/epi-backend
            cd /var/www/epi-backend
      
            echo "üßπ Cleaning up temporary files..."
            sudo rm -rf /tmp/* || true
            sudo journalctl --vacuum-time=3d || true
            echo "‚úÖ Cleanup completed"
      
            # Check if repo already exists
            if [ -d .git ]; then
              echo "üîÑ Repo found ‚Äî switching to SSH and pulling latest..."
              git remote set-url origin git@github.com:nabeelanasaritsaoirse/epi-backend.git
              git fetch origin main
              git reset --hard origin/main
            elif [ "$(ls -A .)" ]; then
              echo "‚ö†Ô∏è Non-git directory found ‚Äî clearing and recloning..."
              rm -rf *
              git clone git@github.com:nabeelanasaritsaoirse/epi-backend.git .
            else
              echo "üì¶ Cloning repository for the first time..."
              git clone git@github.com:nabeelanasaritsaoirse/epi-backend.git .
            fi
      
            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev
      
            echo "‚öôÔ∏è Writing environment variables..."
            cat <<EOT > .env
              PORT=5000
              MONGODB_URI=${{ secrets.MONGODB_URI }}
              JWT_SECRET=${{ secrets.JWT_SECRET }}
              FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
              FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
              FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}
              RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
              RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
            EOT
      
            echo "üö¶ Restarting PM2..."
            pm2 restart epi-backend || pm2 start npm --name "epi-backend" -- start
            pm2 save
      
            echo "‚úÖ Deployment completed successfully!"
          EOF

          # ‚úÖ Send email on successful deployment
          - name: Send Success Email Notification
            if: success()
            uses: dawidd6/action-send-mail@v3
            with:
              server_address: smtp.gmail.com
              server_port: 465
              username: ${{ secrets.EMAIL_USERNAME }}
              password: ${{ secrets.EMAIL_PASSWORD }}
              subject: "‚úÖ EPI Backend Deployment Successful"
              body: |
                üéâ The backend has been successfully deployed to AWS EC2.
          
                Details:
                - Host: ${{ secrets.EC2_HOST }}
                - User: ${{ secrets.EC2_USER }}
                - Environment: Production
                - Time: ${{ github.run_started_at }}
          
                Commit: ${{ github.sha }}
                Repository: ${{ github.repository }}
          
                üöÄ Deployment completed successfully via GitHub Actions!
              to: "youremail@company.com"
              from: "GitHub CI/CD Bot <noreply@github.com>"
          # ‚ùå Send email on failed deployment
          - name: Send Failure Email Notification
            if: failure()
            uses: dawidd6/action-send-mail@v3
            with:
              server_address: smtp.gmail.com
              server_port: 465
              username: ${{ secrets.EMAIL_USERNAME }}
              password: ${{ secrets.EMAIL_PASSWORD }}
              subject: "‚ùå EPI Backend Deployment Failed"
              body: |
                ‚ö†Ô∏è The deployment to AWS EC2 has failed!
          
                Details:
                - Host: ${{ secrets.EC2_HOST }}
                - User: ${{ secrets.EC2_USER }}
                - Workflow: ${{ github.workflow }}
                - Job: ${{ github.job }}
                - Time: ${{ github.run_started_at }}
          
                Commit: ${{ github.sha }}
                Repository: ${{ github.repository }}
                Run logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
                Please review the logs and fix the issue.
              to: "youremail@company.com"
              from: "GitHub CI/CD Bot <noreply@github.com>"
          
